<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Louis Olive">

<title>US Treasuries</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="04_US_treasury_bonds_files/libs/clipboard/clipboard.min.js"></script>
<script src="04_US_treasury_bonds_files/libs/quarto-html/quarto.js"></script>
<script src="04_US_treasury_bonds_files/libs/quarto-html/popper.min.js"></script>
<script src="04_US_treasury_bonds_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="04_US_treasury_bonds_files/libs/quarto-html/anchor.min.js"></script>
<link href="04_US_treasury_bonds_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="04_US_treasury_bonds_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="04_US_treasury_bonds_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="04_US_treasury_bonds_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="04_US_treasury_bonds_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">US Treasuries</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Louis Olive </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image <span class="im">as</span> Img</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>dir_data <span class="op">=</span> <span class="st">'../data'</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>dir_assets <span class="op">=</span> <span class="st">'./assets'</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img_colab(img_path):</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Helper function returning an image to be displayed by Jupyter Notebook / IPython.display module.</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">    path : path to image</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The image should be in a child folder "./assets".</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    display(Img(os.path.join(dir_assets, img_path)))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="55">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Within Google Colab (uncomment below)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # mount my Google Drive on the VM</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from google.colab import drive</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># drive.mount('/gdrive')</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # You should have already created a 'teaching_Python' folder </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # within your Google Drive to persist code and data</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># # the following code should then list the files in the data folder</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_python = '/gdrive/MyDrive/teaching_Python'</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_data = os.path.join(dir_python, 'data')</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># os.listdir(dir_data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Sometimes you have to use a http POST request, for example when dealing with forms. For example on the FED TreasuryDirect website, in order to get a daily list of US Treasury prices, you first have to specificy a value date:</p>

<!---
do not work on Colab
portable alternative below
![Image](./assets/treasury_post_input.png)
-->
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'treasury_post_input.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Inspecting a little bit the web page, we see that a POST request is launched together with date parameters:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'treasury_post_finish.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can use <code>requests</code> package to submit a POST reauest with params:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>treasury_post_url <span class="op">=</span> <span class="st">'https://www.treasurydirect.gov/GA-FI/FedInvest/selectSecurityPriceDate'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib <span class="im">import</span> parse</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>month <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>day <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>user_agent <span class="op">=</span> {<span class="st">'User-Agent'</span>: <span class="st">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36'</span>}</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>post_params <span class="op">=</span> <span class="ss">f'priceDate.month=</span><span class="sc">{</span>month<span class="sc">}</span><span class="ss">&amp;priceDate.day=</span><span class="sc">{</span>day<span class="sc">}</span><span class="ss">&amp;priceDate.year=</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&amp;submit=Show+Prices'</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.post(treasury_post_url, data<span class="op">=</span>parse.parse_qs(post_params), headers<span class="op">=</span>user_agent)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;Response [200]&gt;</code></pre>
</div>
</div>
<p>Reading the content of the response to pandas:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_treasuries <span class="op">=</span> pd.read_html(StringIO(<span class="bu">str</span>(BeautifulSoup(r.content))))[<span class="dv">0</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>df_treasuries.head(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CUSIP</th>
<th data-quarto-table-cell-role="th">SECURITY TYPE</th>
<th data-quarto-table-cell-role="th">RATE</th>
<th data-quarto-table-cell-role="th">MATURITY DATE</th>
<th data-quarto-table-cell-role="th">CALL DATE</th>
<th data-quarto-table-cell-role="th">BUY</th>
<th data-quarto-table-cell-role="th">SELL</th>
<th data-quarto-table-cell-role="th">END OF DAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>912797GU5</td>
<td>MARKET BASED BILL</td>
<td>0.000%</td>
<td>09/26/2023</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.985389</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>912796CS6</td>
<td>MARKET BASED BILL</td>
<td>0.000%</td>
<td>09/28/2023</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.956167</td>
<td>99.970778</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>912797GV3</td>
<td>MARKET BASED BILL</td>
<td>0.000%</td>
<td>10/03/2023</td>
<td>NaN</td>
<td>99.883111</td>
<td>99.882889</td>
<td>99.897528</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>912796YJ2</td>
<td>MARKET BASED BILL</td>
<td>0.000%</td>
<td>10/05/2023</td>
<td>NaN</td>
<td>99.853750</td>
<td>99.853333</td>
<td>99.868000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Exercise</strong> example of data analysis</p>
<p>The aim of the exercise is to scrape US Treasury data from <code>treasurydirect.gov</code> website given a range of dates then perform some analytics.</p>
<ul>
<li>Using Python <a href="https://docs.python.org/3/library/datetime.html"><code>datetime</code> package</a> and given a start and end dates write a function returning a list of business days (you don’t have to deal with business holidays in this function) within the range. The <code>.weekday()</code> method for datetime.date objects and <code>datetime.timedelta()</code> will be useful.</li>
</ul>
<p>Basic usage of datetime:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">9</span>, <span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">9</span>, <span class="dv">28</span>) </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>another_date <span class="op">=</span> <span class="st">'27/09/2023'</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>another_date <span class="op">=</span> datetime.datetime.strptime(another_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>).date()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(another_date.year)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(another_date.day)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(another_date.month)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Then for each business day, get US treasury prices from <code>treasurydirect.gov</code> using the post request that we have seen before. Store the results in a pandas DataFrame keeping the original columns CUSIP:END OF DAY but adding before a column VALUE DATE corresponding to the business day (you can use <code>.insert(loc=0,..)</code>). Then save this DataFrame to a .csv file in the <code>data</code> folder of your Classroom.</p></li>
<li><p>The aim is now to be able to imply a yield from a US Treasury Note/Bond price and its characteristics (Coupon, Maturity). We decompose the problem in two steps:</p>
<ul>
<li><p>first creating a function <code>price_bond</code> that given a pricing date, a maturity date, a coupon, a yield and assuming the coupon is paid bi-annualy returns the price of a bond. To simplify you can first start by assuming the pricing date is the issue date of the bond or a coupon date. Then handle any pricing dates.</p></li>
<li><p>second given this function <code>price_bond</code> and a bond price <code>P</code>, “imply” the yield to maturity being the yield to input to <code>price_bond</code> to retrieve the bond price. For that you will have to use a solver or an optimizer. Basically you want to find the yield solving <code>price_bond(yield)</code>- <code>P</code> = 0. For that you can implement from scratch for example a bisection method (see Wikipedia article <a href="https://en.wikipedia.org/wiki/Bisection_method">here</a> and also <a href="https://pythonnumericalmethods.berkeley.edu/notebooks/chapter19.00-Root-Finding.html">here</a> for root finding methods with Python) or use the <code>scipy.optimize.bisect</code> or <code>scipy.optimize.newton</code>. Once finished put your program inside a <code>bond_ytm</code> function.</p></li>
</ul></li>
<li><p>Apply the <code>bond_ytm</code> to your pandas DataFrame of US treasury prices, to get a bid/ask yield to maturity for each day/CUSIP where SECURITY TYPE is either <code>MARKET BASED NOTE</code> or <code>MARKET BASED BOND</code>.</p></li>
<li><p>Plot for a given business day the yields of US Treasuries with respect to their maturity to get a first sense of the data</p></li>
<li><p>The ECB and many other central banks use the Nelson Siegel parametrization <a href="https://www.ecb.europa.eu/stats/financial_markets_and_interest_rates/euro_area_yield_curves/html/index.en.html">see here</a> to estimate euro area government bond yield curves from government bonds market prices. The original motivation for this model was to create a parsimonious model of the interest rate curve that could capture the range of shapes generally seen in yield curves: monotonic form and with humps in various areas of the curve. The Nelson-Siegel yield function (1987) take the form:</p></li>
</ul>
<p><span class="math display">\[
y(m) = \beta_0 +
\beta_1  \frac{\left( 1 - \exp (-
m / \tau) \right)}{m / \tau}  + \beta_2  \left( \frac{\left( 1 - \exp (-
m / \tau) \right)}{m / \tau} - \exp \left( -
m / \tau \right)  \right)
\]</span></p>
<p>Svensson (1994) adds the additional term:</p>
<p><span class="math display">\[
+ \beta_3  \left( \frac{\left( 1 - \exp (-
m / \tau_2) \right)}{m / \tau_2} - \exp \left( -
m / \tau_2 \right)  \right)
\]</span></p>
<p>First define a <code>nss_yield</code> and a <code>ns_yield</code> function allowing you to plot a Nelson Siegel (Svensson) yield curve given maturity and its parameters.</p>
<p>You can also plot each “factor” of the model to get a sense on the formula.</p>
<p>We will see how to fit the parameters using either the package <code>nelson_siegel_svensson</code> or <code>scipy</code></p>
<p>Start of the exercise</p>
<ul>
<li>Using Python <a href="https://docs.python.org/3/library/datetime.html"><code>datetime</code> package</a> and given a start and end dates write a function returning a list of business days (you don’t have to deal with business holidays in this function) within the range. The <code>.weekday()</code> method for datetime.date objects and <code>datetime.timedelta()</code> will be useful.</li>
</ul>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">9</span>, <span class="dv">14</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">9</span>, <span class="dv">29</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Date range: [</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">]'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Date range: [2023-09-14, 2023-09-29]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_bizdays(start_date, end_date):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    bizdays <span class="op">=</span> []</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    curr_date <span class="op">=</span> start_date</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> curr_date <span class="op">&lt;=</span> end_date:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> curr_date.weekday() <span class="op">&lt;=</span> <span class="dv">4</span>:</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            bizdays.append(curr_date)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        curr_date <span class="op">=</span> curr_date <span class="op">+</span> datetime.timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bizdays</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>bizdays <span class="op">=</span> generate_bizdays(start_date, end_date)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>bizdays</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[datetime.date(2023, 9, 14),
 datetime.date(2023, 9, 15),
 datetime.date(2023, 9, 18),
 datetime.date(2023, 9, 19),
 datetime.date(2023, 9, 20),
 datetime.date(2023, 9, 21),
 datetime.date(2023, 9, 22),
 datetime.date(2023, 9, 25),
 datetime.date(2023, 9, 26),
 datetime.date(2023, 9, 27),
 datetime.date(2023, 9, 28),
 datetime.date(2023, 9, 29)]</code></pre>
</div>
</div>
<ul>
<li>Then for each business day, get US treasury prices from <code>treasurydirect.gov</code> using the post request that we have seen before. Store the results in a pandas DataFrame keeping the original columns CUSIP:END OF DAY but adding before a column VALUE DATE corresponding to the business day (you can use <code>.insert(loc=0,..)</code>). Then save this DataFrame to a .csv file in the <code>data</code> folder of your Classroom.</li>
</ul>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_treasury_prices(bizdays):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    dict_df_treasuries <span class="op">=</span> {}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date <span class="kw">in</span> bizdays:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(date)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> date.month</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        day <span class="op">=</span> date.day</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        year <span class="op">=</span> date.year</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        post_params <span class="op">=</span> <span class="ss">f'priceDate.month=</span><span class="sc">{</span>month<span class="sc">}</span><span class="ss">&amp;priceDate.day=</span><span class="sc">{</span>day<span class="sc">}</span><span class="ss">&amp;priceDate.year=</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&amp;submit=Show+Prices'</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> requests.post(treasury_post_url, data<span class="op">=</span>parse.parse_qs(post_params), headers<span class="op">=</span>user_agent)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        df_treasuries <span class="op">=</span> pd.read_html(StringIO(<span class="bu">str</span>(BeautifulSoup(r.content))))[<span class="dv">0</span>]</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        df_treasuries[<span class="st">'RATE'</span>] <span class="op">=</span> df_treasuries[<span class="st">'RATE'</span>].<span class="bu">str</span>.replace(<span class="st">'%'</span>, <span class="st">''</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        df_treasuries[<span class="st">'RATE'</span>] <span class="op">=</span> pd.to_numeric(df_treasuries[<span class="st">'RATE'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>) <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        df_treasuries[<span class="st">'MATURITY DATE'</span>] <span class="op">=</span> pd.to_datetime(df_treasuries[<span class="st">'MATURITY DATE'</span>],</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                                                        <span class="bu">format</span><span class="op">=</span><span class="st">'%m/</span><span class="sc">%d</span><span class="st">/%Y'</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>                                                        errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        df_treasuries.insert(loc<span class="op">=</span><span class="dv">0</span>, column<span class="op">=</span><span class="st">'VALUE DATE'</span>, value <span class="op">=</span> pd.to_datetime(date,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                                                                                <span class="bu">format</span><span class="op">=</span><span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle the case of empty data</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df_treasuries.empty:</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            dict_df_treasuries[date] <span class="op">=</span> <span class="st">'Isin not listed'</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            dict_df_treasuries[date] <span class="op">=</span> df_treasuries</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dict_df_treasuries</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dict_df_treasuries <span class="op">=</span> get_treasury_prices(bizdays)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2023-09-14
2023-09-15
2023-09-18
2023-09-19
2023-09-20
2023-09-21
2023-09-22
2023-09-25
2023-09-26
2023-09-27
2023-09-28
2023-09-29</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_prices <span class="op">=</span> pd.concat([v <span class="cf">for</span> _,v <span class="kw">in</span> dict_df_treasuries.items() <span class="cf">if</span> <span class="bu">isinstance</span>(v, pd.DataFrame)],</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                 ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_treasuries_prices.dtypes)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>df_treasuries_prices.head(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>VALUE DATE       datetime64[ns]
CUSIP                    object
SECURITY TYPE            object
RATE                    float64
MATURITY DATE    datetime64[ns]
CALL DATE               float64
BUY                     float64
SELL                    float64
END OF DAY              float64
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VALUE DATE</th>
<th data-quarto-table-cell-role="th">CUSIP</th>
<th data-quarto-table-cell-role="th">SECURITY TYPE</th>
<th data-quarto-table-cell-role="th">RATE</th>
<th data-quarto-table-cell-role="th">MATURITY DATE</th>
<th data-quarto-table-cell-role="th">CALL DATE</th>
<th data-quarto-table-cell-role="th">BUY</th>
<th data-quarto-table-cell-role="th">SELL</th>
<th data-quarto-table-cell-role="th">END OF DAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2023-09-14</td>
<td>912797GT8</td>
<td>MARKET BASED BILL</td>
<td>0.0</td>
<td>2023-09-19</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.926944</td>
<td>99.941333</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2023-09-14</td>
<td>912796CR8</td>
<td>MARKET BASED BILL</td>
<td>0.0</td>
<td>2023-09-21</td>
<td>NaN</td>
<td>99.898111</td>
<td>99.897917</td>
<td>99.912500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2023-09-14</td>
<td>912797GU5</td>
<td>MARKET BASED BILL</td>
<td>0.0</td>
<td>2023-09-26</td>
<td>NaN</td>
<td>99.825167</td>
<td>99.824667</td>
<td>99.838972</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2023-09-14</td>
<td>912796CS6</td>
<td>MARKET BASED BILL</td>
<td>0.0</td>
<td>2023-09-28</td>
<td>NaN</td>
<td>99.796417</td>
<td>99.795444</td>
<td>99.809333</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_prices.tail(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VALUE DATE</th>
<th data-quarto-table-cell-role="th">CUSIP</th>
<th data-quarto-table-cell-role="th">SECURITY TYPE</th>
<th data-quarto-table-cell-role="th">RATE</th>
<th data-quarto-table-cell-role="th">MATURITY DATE</th>
<th data-quarto-table-cell-role="th">CALL DATE</th>
<th data-quarto-table-cell-role="th">BUY</th>
<th data-quarto-table-cell-role="th">SELL</th>
<th data-quarto-table-cell-role="th">END OF DAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5305</td>
<td>2023-09-29</td>
<td>91282CFS5</td>
<td>MARKET BASED FRN</td>
<td>0.05620</td>
<td>2024-10-31</td>
<td>NaN</td>
<td>100.098973</td>
<td>100.077777</td>
<td>100.083075</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5306</td>
<td>2023-09-29</td>
<td>91282CGF2</td>
<td>MARKET BASED FRN</td>
<td>0.05681</td>
<td>2025-01-31</td>
<td>NaN</td>
<td>100.154413</td>
<td>100.128462</td>
<td>100.131705</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5307</td>
<td>2023-09-29</td>
<td>91282CGY1</td>
<td>MARKET BASED FRN</td>
<td>0.05649</td>
<td>2025-04-30</td>
<td>NaN</td>
<td>100.056931</td>
<td>100.039800</td>
<td>100.051218</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5308</td>
<td>2023-09-29</td>
<td>91282CHS3</td>
<td>MARKET BASED FRN</td>
<td>0.05605</td>
<td>2025-07-31</td>
<td>NaN</td>
<td>99.921257</td>
<td>99.912499</td>
<td>99.916878</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Saving to csv</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_prices.to_csv(os.path.join(dir_data, <span class="st">'df_treasuries_prices.csv'</span>), index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>The aim is now to be able to imply a yield from a US Treasury Note/Bond price and its characteristics (Coupon, Maturity). We decompose the problem in two steps:</p>
<ul>
<li>first creating a function <code>price_bond</code> that given a pricing date, a maturity date, a coupon, a yield and assuming the coupon is paid bi-annualy returns the price of a bond. To simplify you can first start by assuming the pricing date is the issue date of the bond or a coupon date. Then handle any pricing dates.</li>
</ul></li>
</ul>
<p>To set these ideas on a simple example, let’s choose a specific Treasury Note, with CUSIP number 91282CDN8, maturing December 15, 2024, paying a 1% coupon semi-annually:</p>
<div class="cell" data-execution_count="85">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'91282CDN8_issue.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We define here the bond main characteristics:</p>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>clean_price <span class="op">=</span> <span class="fl">94.984375</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>par_value <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> <span class="st">'29/09/2023'</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>last_coupon <span class="op">=</span> <span class="st">'15/06/2023'</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>next_coupon <span class="op">=</span> <span class="st">'15/12/2023'</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> <span class="st">'15/12/2024'</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>issue_date <span class="op">=</span> <span class="st">'15/12/2021'</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>coupon <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>freq <span class="op">=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We remind here the bond yield problem as stated in <a href="https://www.icmagroup.org/assets/documents/Media/Bondmarketsbook/Bond%20markets_structures%20and%20yield%20calculations.pdf">this ISMA publication</a>:</p>
<div class="cell" data-execution_count="87">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'yield_formula_I.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We first start with a naive implementation, without caring too much about daycount conventions, ajustments etc:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_price_naive(yld, pricing_date, maturity_date, coupon, redemption, frequency, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We adapt the 'annual' coupon to the payment frequency</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    coupon <span class="op">=</span> redemption <span class="op">*</span> (coupon <span class="op">/</span> <span class="dv">100</span> <span class="op">/</span> frequency)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We compute the time in years to maturity</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    L_n <span class="op">=</span> (maturity_date <span class="op">-</span> pricing_date).days <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It is assumed a full interest period is always 1.0/frequency and the coupon is unadjusted</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We first build a list of cashflows times in years starting backward from maturity</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    time_to_future_cf <span class="op">=</span> <span class="bu">list</span>(<span class="bu">reversed</span>([L_n<span class="op">-</span>i<span class="op">/</span>frequency <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">int</span>(frequency <span class="op">*</span> L_n) <span class="op">+</span> <span class="dv">1</span>)]))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The dcf of coupons + redemption is known as Dirty Price (ie including accrued interests)</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It is the price you have to pay to settle a bond, but usually bonds are quoted</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with Clean Prices (Dirty Price - Accrued Interests)</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variant where the yield is compounded with respect to bond frequency</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dirty_price = (sum([coupon/(1 + yld / frequency) ** (frequency * L_i) for L_i in time_to_future_cf]) </span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#             + redemption / (1 + yld / frequency) ** (frequency * L_n))</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annual yield compounding as per ISMA</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    dirty_price <span class="op">=</span> (<span class="bu">sum</span>([coupon<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> yld) <span class="op">**</span> L_i <span class="cf">for</span> L_i <span class="kw">in</span> time_to_future_cf]) </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> redemption <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> yld) <span class="op">**</span> L_n)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We then compute accrued interests</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    accrued_interest <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>frequency <span class="op">-</span> time_to_future_cf[<span class="dv">0</span>])<span class="op">*</span>coupon<span class="op">*</span>frequency</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    clean_price <span class="op">=</span> dirty_price <span class="op">-</span> accrued_interest</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose: </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Clean price: </span><span class="sc">{</span>clean_price<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Dirty price: </span><span class="sc">{</span>dirty_price<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Accrued interest: </span><span class="sc">{</span>accrued_interest<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Cashflow schedule: </span><span class="sc">{</span>time_to_future_cf<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> clean_price</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>bond_price_naive(yld <span class="op">=</span> <span class="fl">0.05391482199427463</span>,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>coupon <span class="op">=</span> coupon,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>redemption <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> freq,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>verbose<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Clean price: 94.98437500001599
Dirty price: 95.270676369879
Accrued interest: 0.2863013698630137
Cashflow schedule: [0.2136986301369863, 0.7136986301369863, 1.2136986301369863]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>94.98437500001599</code></pre>
</div>
</div>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> <span class="st">'29/09/2023'</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> <span class="st">'15/12/2024'</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>maturity_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>datetime.datetime(2024, 12, 15, 0, 0)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>L_n <span class="op">=</span> (maturity_date <span class="op">-</span> pricing_date).days <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>L_n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>1.2136986301369863</code></pre>
</div>
</div>
<p>Using list comprehension to generate CF starting backward from maturity</p>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>[L_n<span class="op">-</span>i<span class="op">/</span>freq <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">int</span>(freq <span class="op">*</span> L_n) <span class="op">+</span> <span class="dv">1</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>[1.2136986301369863, 0.7136986301369863, 0.2136986301369863]</code></pre>
</div>
</div>
<p>Then reversing the list to get chronological order, for example using Python built-in <code>reversed</code> <a href="https://docs.python.org/3/library/functions.html#reversed">function</a>. See other ways <a href="https://stackoverflow.com/questions/28369740/alternate-python-list-reverse-solution-needed">here</a>:</p>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>reversed_list_it <span class="op">=</span> <span class="bu">reversed</span>([L_n<span class="op">-</span>i<span class="op">/</span>freq <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">int</span>(freq <span class="op">*</span> L_n) <span class="op">+</span> <span class="dv">1</span>)])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>reversed_list_it</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>&lt;list_reverseiterator at 0x16853b970&gt;</code></pre>
</div>
</div>
<p>Unfortunately, reversed produces an <a href="https://docs.python.org/3/glossary.html#term-iterator">iterator</a> and not a list:</p>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> l <span class="kw">in</span> reversed_list_it:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(l)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>reversed_list <span class="op">=</span> <span class="bu">list</span>(reversed_list_it)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>reversed_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>[]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>reversed_list_it <span class="op">=</span> <span class="bu">reversed</span>([L_n<span class="op">-</span>i<span class="op">/</span>freq <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">int</span>(freq <span class="op">*</span> L_n) <span class="op">+</span> <span class="dv">1</span>)])</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>reversed_list <span class="op">=</span> <span class="bu">list</span>(reversed_list_it)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>reversed_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>[0.2136986301369863, 0.7136986301369863, 1.2136986301369863]</code></pre>
</div>
</div>
<p>We plot the Clean Price function with respect to yield, we briefly introduce here some <code>NumPy</code> objects;</p>
<p><code>np.linspace()</code> allows to return evenly spaced numbers over a specified interval, which can be useful in the context of ploting a function.</p>
<p><code>np.vectorize()</code> allows to return evenly spaced numbers over a specified interval, which can be useful in the context of ploting a function.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="dv">150</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>bond_price_naive_v <span class="op">=</span> np.vectorize(bond_price_naive)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> bond_price_naive_v(x,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                       pricing_date <span class="op">=</span> datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>                       maturity_date <span class="op">=</span> datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                       coupon <span class="op">=</span> coupon,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                       redemption <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                       frequency <span class="op">=</span> freq)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(y))</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>y[::<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.ndarray'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>array([102.45178728, 101.53511035, 100.63331611,  99.74605617,
        98.87299272,  98.01379818,  97.16815484,  96.33575444,
        95.51629785,  94.70949476,  93.91506333,  93.13272987,
        92.36222863,  91.60330141,  90.85569738])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mtick</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>ax.plot(x, y)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>ax.plot(x, clean_price <span class="op">*</span> np.ones_like(x))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Yield'</span>, ylabel<span class="op">=</span><span class="st">'Bond Clean Price'</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>       title<span class="op">=</span><span class="st">'Clean Price of 3 Year Note 91282CDN8 (15-Dec-2024) w.r.t. Yield'</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(mtick.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>))</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We use <code>scipy.optimize.newton()</code> to equalize market price to bond price function at the yield to maturity:</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.optimize <span class="im">as</span> optimize</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_ytm_naive(clean_price, pricing_date, maturity_date, coupon, redemption, frequency, ytm_0):</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we define the function we want to solve wrt to yield (ie solve Price(yield) = Market price )</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> equalize_price(yld):</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        CP <span class="op">=</span> bond_price_naive(yld, pricing_date, maturity_date, coupon, redemption, frequency)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> CP <span class="op">-</span> clean_price</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    ytm <span class="op">=</span> optimize.newton(equalize_price, ytm_0)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    bond_price_naive(ytm, pricing_date, maturity_date, coupon, redemption, frequency, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ytm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>bond_ytm_naive(clean_price <span class="op">=</span> clean_price,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>coupon <span class="op">=</span> coupon,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>redemption <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> freq,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>ytm_0 <span class="op">=</span> <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Clean price: 94.98437500001599
Dirty price: 95.270676369879
Accrued interest: 0.2863013698630137
Cashflow schedule: [0.2136986301369863, 0.7136986301369863, 1.2136986301369863]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>0.05391482199427463</code></pre>
</div>
</div>
<p>We start caring a little bit about daycounts and conventions, first defining a function that shift payments on week ends to Monday:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_business_day(a_datetime):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># wd = a_datetime.isoweekday()</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # if Satursday or Sunday</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if wd in set((6, 7)):</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     # if Satursday or Sunday shift by either 2 or 1 day to Monday</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     a_datetime += datetime.timedelta(days=8 - wd)</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    wd <span class="op">=</span> a_datetime.weekday()</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if Satursday or Sunday</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> wd <span class="kw">in</span> <span class="bu">set</span>((<span class="dv">5</span>, <span class="dv">6</span>)):</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if Satursday or Sunday shift by either 2 or 1 day to Monday</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        a_datetime <span class="op">+=</span> datetime.timedelta(days<span class="op">=</span><span class="dv">7</span> <span class="op">-</span> wd)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a_datetime</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>we_sun <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>we_sat <span class="op">=</span> datetime.date(<span class="dv">2023</span>, <span class="dv">9</span>, <span class="dv">30</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adjust_business_day(we_sat))</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(adjust_business_day(we_sun))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2023-10-02
2023-10-02</code></pre>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_price_with_adjustments(yld, pricing_date, maturity_date, coupon, redemption, frequency, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We compute the nominal coupon</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    coupon <span class="op">=</span> redemption <span class="op">*</span> coupon <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We compute the time in years to maturity</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    L_n <span class="op">=</span> (maturity_date <span class="op">-</span> pricing_date).days <span class="op">/</span> <span class="dv">365</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Defining a shift in months corresponding to bond frequency</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    months_shift <span class="op">=</span> relativedelta(months<span class="op">=</span><span class="bu">int</span>(<span class="dv">12</span> <span class="op">/</span> frequency))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We first build a list of cashflows dates starting backward from maturity</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    cf_schedule <span class="op">=</span> <span class="bu">list</span>(<span class="bu">reversed</span>([maturity_date <span class="op">-</span> i <span class="op">*</span> months_shift </span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(freq<span class="op">*</span><span class="bu">int</span>(L_n)<span class="op">+</span><span class="dv">2</span>)]))</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusting payment dates (ie cashflow dates) if weekend</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    cf_payment_dates <span class="op">=</span> [(adjust_business_day(cf) <span class="op">-</span> pricing_date).days<span class="op">/</span><span class="dv">365</span> <span class="cf">for</span> cf <span class="kw">in</span> cf_schedule]</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We first build a list of cashflows times in years starting backward from maturity</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    time_to_future_cf <span class="op">=</span> cf_payment_dates</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The interest calculation period are unadjusted, we use year fractions of </span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exact interest dates over 365 to compute interests (Actual365Fixed convention)</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cf_period_fraction = [(cf - pricing_date).days/365 for cf in cf_schedule]</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    year_fraction <span class="op">=</span> [(j<span class="op">-</span>i).days<span class="op">/</span><span class="dv">365</span> <span class="cf">for</span> i, j <span class="kw">in</span> <span class="bu">zip</span>(cf_schedule[:<span class="op">-</span><span class="dv">1</span>], cf_schedule[<span class="dv">1</span>:])]</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The dcf of coupons + redemption is known as Dirty Price (ie including accrued interests)</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># It is the price you have to pay to settle a bond, but usually bonds are quoted</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with Clean Prices (Dirty Price - Accrued Interests)</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variant where the yield is compounded with respect to bond frequency</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dcf = (sum([coupon * frequency * yf /(1 + yld / frequency) ** (frequency * l_i) for yf, l_i in zip(year_fraction , cf_payment_dates[1:])])</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#             + redemption / (1 + yld / frequency) ** (frequency * cf_payment_dates[-1]))</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annual yield compounding as per ISMA       </span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    dirty_price <span class="op">=</span> (<span class="bu">sum</span>([coupon <span class="op">*</span> yf <span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> yld) <span class="op">**</span> L_i <span class="cf">for</span> yf, L_i <span class="kw">in</span> <span class="bu">zip</span>(year_fraction , cf_payment_dates[<span class="dv">1</span>:])])</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> redemption <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> yld) <span class="op">**</span> cf_payment_dates[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We then compute accrued interests</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    accrued_interest <span class="op">=</span> (pricing_date <span class="op">-</span> cf_schedule[<span class="dv">0</span>]).days <span class="op">/</span> <span class="dv">365</span> <span class="op">*</span> coupon</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>    clean_price <span class="op">=</span> dirty_price <span class="op">-</span> accrued_interest</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose: </span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Clean price: </span><span class="sc">{</span>clean_price<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Dirty price: </span><span class="sc">{</span>dirty_price<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Accrued interest: </span><span class="sc">{</span>accrued_interest<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Cashflow schedule, time to mat: </span><span class="sc">{</span>time_to_future_cf<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Cashflow schedule, dates: </span><span class="sc">{</span>cf_schedule<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> clean_price</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_ytm_with_adjustments(clean_price, pricing_date, maturity_date, coupon, redemption, frequency, ytm_0):</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we define the function we want to solve wrt to yield (ie solve Price(yield) = Market price )</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> equalize_price(yld):</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>        CP <span class="op">=</span> bond_price_with_adjustments(yld, pricing_date, maturity_date, coupon, redemption, frequency)</span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> CP <span class="op">-</span> clean_price</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>    ytm <span class="op">=</span> optimize.newton(equalize_price, ytm_0)</span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>    bond_price_with_adjustments(ytm, pricing_date, maturity_date, coupon, redemption, frequency, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ytm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>bond_ytm_with_adjustments(clean_price <span class="op">=</span> clean_price,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>pricing_date <span class="op">=</span> datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>maturity_date <span class="op">=</span> datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>coupon <span class="op">=</span> coupon,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>redemption <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>frequency <span class="op">=</span> freq,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>ytm_0 <span class="op">=</span> <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Clean price: 94.98437500001552
Dirty price: 95.27478595891962
Accrued interest: 0.29041095890410956
Cashflow schedule, time to mat: [-0.29041095890410956, 0.21095890410958903, 0.7178082191780822, 1.2164383561643837]
Cashflow schedule, dates: [datetime.datetime(2023, 6, 15, 0, 0), datetime.datetime(2023, 12, 15, 0, 0), datetime.datetime(2024, 6, 15, 0, 0), datetime.datetime(2024, 12, 15, 0, 0)]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>0.05378899594106901</code></pre>
</div>
</div>
<p>We present here an alternative implementation matching the Excel/Open Office/Google Sheets <code>PRICE</code>/<code>YIELD</code> formulas:</p>
<p>The source code for the Open Office version is available <a href="https://github.com/LibreOffice/core/blob/master/scaddins/source/analysis/analysishelper.cxx#L1134">here</a>. The approach is interesting in that only the first coupon / accrued interest follows market conventions, subsequent payments are supposed to be regular (ie 1 / frequency) allowing a simple implementation (sum of geometric series).</p>
<p>Below the code source for Open Office Price and Yield functions:</p>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'libre_office_get_price.png'</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'libre_office_get_yield.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-38-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We note that a binary search or bisection is used to “solve’ the yield.</p>
<p>Microsoft offers a <a href="https://support.microsoft.com/en-us/office/price-function-3ea9deac-8dfa-436f-a7c8-17ea02c21b0a">light documentation</a> of its <code>PRICE</code> formula for Excel, we will use the same terminology in our Python function (redemption, A, E, DSC/E):</p>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'price_excel_1.png'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'price_excel_2.png'</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'price_excel_3.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-39-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-39-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-39-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_clean_price_excel(bond_yield, pricing_date, maturity_date, coupon, redemption, frequency, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    months_shift <span class="op">=</span> relativedelta(months<span class="op">=</span><span class="bu">int</span>(<span class="dv">12</span> <span class="op">/</span> frequency))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    coupon <span class="op">=</span> coupon <span class="op">/</span> <span class="dv">100</span> <span class="op">/</span> frequency <span class="op">*</span> redemption</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we need a number n of coupon paid to apply the formula</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we start with a rough estimate</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">int</span>(frequency <span class="op">*</span> (maturity_date <span class="op">-</span> pricing_date).days <span class="op">/</span> <span class="dv">365</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we check the estimate of number of coupon and adjust if needed</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span>(maturity_date <span class="op">-</span> n <span class="op">*</span> months_shift <span class="op">&lt;=</span> pricing_date):</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> n<span class="op">-</span><span class="dv">1</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    next_coupon <span class="op">=</span> maturity_date <span class="op">-</span> n <span class="op">*</span> months_shift</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    last_coupon <span class="op">=</span> next_coupon <span class="op">-</span> months_shift</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DSC = number of days from settlement to next coupon date.</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    dsc <span class="op">=</span> (next_coupon <span class="op">-</span> pricing_date).days </span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># E = number of days in coupon period in which the settlement date falls.</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> (next_coupon <span class="op">-</span> last_coupon).days </span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    dsc_e <span class="op">=</span> dsc <span class="op">/</span> e</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    accrual_fraction <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> dsc_e</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A = number of days from beginning of coupon period to settlement date.</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> (pricing_date <span class="op">-</span> last_coupon).days </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we neglect leap years and business days adjustments</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we use the annuity formula for bond PV(coupons, yield) = coupon / yield * (1 - 1 / (1 + y) ** n) using the sum of geometric series</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we need a number n of full interest periods to apply the formula</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    coupons_num <span class="op">=</span> n <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># so we first compute PV(yield, as of previous coupon date)</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>    bond_annuity <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bond_yield <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>        bond_annuity <span class="op">=</span> coupon <span class="op">*</span> coupons_num </span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Using Sum_i=0..n (coupon * 1 / (1 + bond_yield/frequency) ** (i + dsc_e))</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">#                 = coupon *</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>        bond_annuity <span class="op">=</span> coupon <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (bond_yield<span class="op">/</span>frequency) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> bond_yield<span class="op">/</span>frequency) <span class="op">**</span> coupons_num)</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Direct implementation of Excel formula, it is quicker to use the sum of geometric series formula below</span></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for i in range(coupons_num):</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     dcf = coupon * 1 / (1 + bond_yield/frequency) ** (i + dsc_e)</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     print(f'cf{i}: {dcf}')</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     bond_annuity = bond_annuity + dcf</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bond_pv = bond_annuity + redemption * 1 / (1 + bond_yield/frequency) ** (coupons_num - 1 + dsc_e)</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we add redemption</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>    bond_pv_last_coupon <span class="op">=</span> bond_annuity <span class="op">+</span> redemption <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> bond_yield<span class="op">/</span>frequency) <span class="op">**</span> coupons_num</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and get PV(yield, as of pricing date) by calculating FV(PV(as of previous coupon date), as of pricing date)</span></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>    bond_pv <span class="op">=</span>  (<span class="dv">1</span> <span class="op">+</span> bond_yield<span class="op">/</span>freq) <span class="op">**</span> accrual_fraction <span class="op">*</span> bond_pv_last_coupon</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>    accrued_interest <span class="op">=</span>  accrual_fraction <span class="op">*</span> coupon </span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>    clean_price <span class="op">=</span> bond_pv <span class="op">-</span> accrued_interest</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Clean price: </span><span class="sc">{</span>clean_price<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Dirty price: </span><span class="sc">{</span>bond_pv<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Accrued interest: </span><span class="sc">{</span>accrued_interest<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Last coupon date: </span><span class="sc">{</span>last_coupon<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Next coupon date: </span><span class="sc">{</span>next_coupon<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'A: </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'E: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'DSC_E: </span><span class="sc">{</span>dsc_e<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Accrual fraction: </span><span class="sc">{</span>accrual_fraction<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Num coupon: </span><span class="sc">{</span>coupons_num<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bond_pv <span class="op">-</span> accrued_interest</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bond_ytm_excel(clean_price, pricing_date, maturity_date, coupon, redemption, frequency, ytm_0, method <span class="op">=</span> <span class="st">"newton"</span>):</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>    ytm_func <span class="op">=</span> <span class="kw">lambda</span> y: bond_clean_price_excel(y, pricing_date, maturity_date, coupon, redemption, frequency) <span class="op">-</span> clean_price</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">"newton"</span>:</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> optimize.newton(ytm_func, ytm_0)</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> optimize.bisect(ytm_func, <span class="op">-</span>ytm_0, <span class="dv">5</span><span class="op">*</span>ytm_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>bond_clean_price_excel(<span class="fl">0.0533260086420741</span>,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                       datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),  </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                       datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                       coupon,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">100</span>,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                       freq,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>                       verbose<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Clean price: 94.98437499999991
Dirty price: 95.27399248633871
Accrued interest: 0.2896174863387978
Last coupon date: 2023-06-15 00:00:00
Next coupon date: 2023-12-15 00:00:00
A: 106
E: 183
DSC_E: 0.4207650273224044
Accrual fraction: 0.5792349726775956
Num coupon: 3</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>94.98437499999991</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>bond_ytm_excel(clean_price,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),  </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>               coupon,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>               <span class="dv">100</span>,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>               freq,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>               <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>0.053326008642049956</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>bond_ytm_excel(clean_price,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),  </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>               coupon,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>               <span class="dv">100</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>               freq,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>               <span class="fl">0.03</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">"bisect"</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>0.05332600864101551</code></pre>
</div>
</div>
<p>We have briefly verified our Excel like implementation using a Google Sheet. First using PRICE/YIELD formulas. Then step by step computing the PRICE formula (mimicking OpenOffice source code) followed by a solver to obtain the yield:</p>
<div class="cell" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'bond_yield_excel.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We also verify our simple implementation with adjustments using Quantlib a free/open-source library for quantitative finance allowing real life setting of bond pricing conventions:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> QuantLib <span class="im">as</span> ql</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>valuationDate <span class="op">=</span> ql.Date(<span class="dv">29</span>, <span class="dv">9</span>, <span class="dv">2023</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>ql.Settings.instance().evaluationDate <span class="op">=</span> valuationDate</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> ql.Date(<span class="dv">15</span>, <span class="dv">12</span>, <span class="dv">2021</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>maturity <span class="op">=</span> ql.Date(<span class="dv">15</span>, <span class="dv">12</span>, <span class="dv">2024</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.ISDA)</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.ISMA) # equivalent to current ICMA daycount</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.AFB)</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.Bond)</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.Actual365)</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> ql.Actual365Fixed()</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>bond <span class="op">=</span> ql.FixedRateBond(<span class="dv">0</span>, ql.TARGET(), <span class="dv">100</span>, start, maturity, ql.Period(<span class="st">'6M'</span>), [<span class="fl">0.01</span>], day_count, ql.Unadjusted)</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>bond_yield <span class="op">=</span> bond.bondYield(clean_price, day_count, ql.Compounded, ql.Annual, valuationDate)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bond_yield) </span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bond.accruedAmount())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.05378899437976785
0.2904109589041193</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>valuationDate <span class="op">=</span> ql.Date(<span class="dv">29</span>, <span class="dv">9</span>, <span class="dv">2023</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ql.Settings.instance().evaluationDate <span class="op">=</span> valuationDate</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.ISDA)</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.AFB)</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.Bond)</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.Actual365)</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># day_count = ql.ActualActual(ql.ActualActual.ISMA) # equivalent to the ICMA daycount</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>day_count <span class="op">=</span> ql.Actual365Fixed()</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co"># interpolation = ql.Linear()</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>compounding <span class="op">=</span> ql.Compounded</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>compounding_frequency <span class="op">=</span> ql.Semiannual</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>issue_date <span class="op">=</span> ql.Date(<span class="dv">15</span>, <span class="dv">12</span>, <span class="dv">2021</span>)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>maturity <span class="op">=</span> ql.Date(<span class="dv">15</span>, <span class="dv">12</span>, <span class="dv">2024</span>)</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>tenor <span class="op">=</span> ql.Period(ql.Semiannual)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>calendar <span class="op">=</span> ql.TARGET()</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>business_convention <span class="op">=</span> ql.Unadjusted</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co"># business_convention_terminal = ql.ModifiedFollowing</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>business_convention_terminal <span class="op">=</span> ql.Unadjusted</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>date_generation <span class="op">=</span> ql.DateGeneration.Backward</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>month_end <span class="op">=</span> <span class="va">False</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>schedule <span class="op">=</span> ql.Schedule(issue_date, maturity, tenor,</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>                        calendar, business_convention,</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>                        business_convention_terminal, date_generation,</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>                        month_end)</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(schedule))</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>coupon_rate <span class="op">=</span> <span class="fl">.01</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>coupons <span class="op">=</span> [coupon_rate]</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>settlement_days <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>face_value <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>bond <span class="op">=</span> ql.FixedRateBond(settlement_days,</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>                                face_value,</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>                                schedule,</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>                                coupons,</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>                                day_count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[Date(15,12,2021), Date(15,6,2022), Date(15,12,2022), Date(15,6,2023), Date(15,12,2023), Date(15,6,2024), Date(15,12,2024)]</code></pre>
</div>
</div>
<p>Computing bond yield for the fixed rate note:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="bu">help</span>(bond.bondYield)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Help on method bondYield in module QuantLib.QuantLib:

bondYield(*args) method of QuantLib.QuantLib.FixedRateBond instance
    bondYield(Bond self, DayCounter dc, Compounding compounding, Frequency freq, Real accuracy=1.0e-8, Size maxEvaluations=100) -&gt; Real
    bondYield(Bond self, Real cleanPrice, DayCounter dc, Compounding compounding, Frequency freq, Date settlement=Date(), Real accuracy=1.0e-8, Size maxEvaluations=100) -&gt; Real
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>bond_yield <span class="op">=</span> bond.bondYield(clean_price, day_count, ql.Compounded, ql.Annual, valuationDate)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>bond_yield</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>0.05378899437976785</code></pre>
</div>
</div>
<p>Printing nicely QuantLib cashflows to compare with our implementation and Excel:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, c <span class="kw">in</span> <span class="bu">enumerate</span>(bond.cashflows()[:<span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> ql.as_coupon(c)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> c.accrualStartDate()</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> c.accrualEndDate()</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> c.date()</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    CF <span class="op">=</span> c.amount()</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    yf <span class="op">=</span> day_count.yearFraction(valuationDate, d)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    Disc <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> bond_yield) <span class="op">**</span> yf <span class="cf">if</span> d <span class="op">&gt;</span> ql.Date(<span class="dv">29</span>, <span class="dv">9</span>, <span class="dv">2023</span>) <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    CF_discounted <span class="op">=</span> CF <span class="op">*</span> Disc <span class="cf">if</span> d <span class="op">&gt;</span> ql.Date(<span class="dv">29</span>, <span class="dv">9</span>, <span class="dv">2023</span>) <span class="cf">else</span> <span class="fl">0.0</span> </span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    data.append((d1, d2 ,d ,CF ,yf ,Disc ,CF_discounted))</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>data.append((d1, d2, bond.cashflows()[<span class="op">-</span><span class="dv">1</span>].date(), <span class="dv">100</span>, yf, Disc, <span class="dv">100</span><span class="op">*</span>Disc))</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame(data,</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>                 columns <span class="op">=</span> (<span class="st">'Start date'</span>, <span class="st">'End date'</span>, <span class="st">'Payment date'</span>, <span class="st">'CF'</span>, <span class="st">'Year fraction'</span>, <span class="st">'Discount'</span>, <span class="st">'CF (disc.)'</span>),</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>                 index <span class="op">=</span> [<span class="st">''</span>]<span class="op">*</span><span class="bu">len</span>(data))</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daycount basis: </span><span class="sc">{</span>day_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"DCF/Dirty price: </span><span class="sc">{</span><span class="bu">sum</span>(data[<span class="st">'CF (disc.)'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"YTM - Annual: </span><span class="sc">{</span>bond_yield<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cashflows:"</span>)</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daycount basis: Actual/365 (Fixed) day counter
DCF/Dirty price: 95.2747861295364
YTM - Annual: 0.05378899437976785
Cashflows:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Start date</th>
<th data-quarto-table-cell-role="th">End date</th>
<th data-quarto-table-cell-role="th">Payment date</th>
<th data-quarto-table-cell-role="th">CF</th>
<th data-quarto-table-cell-role="th">Year fraction</th>
<th data-quarto-table-cell-role="th">Discount</th>
<th data-quarto-table-cell-role="th">CF (disc.)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th"></td>
<td>December 15th, 2021</td>
<td>June 15th, 2022</td>
<td>June 15th, 2022</td>
<td>0.49863</td>
<td>-1.290411</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th"></td>
<td>June 15th, 2022</td>
<td>December 15th, 2022</td>
<td>December 15th, 2022</td>
<td>0.50137</td>
<td>-0.789041</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th"></td>
<td>December 15th, 2022</td>
<td>June 15th, 2023</td>
<td>June 15th, 2023</td>
<td>0.49863</td>
<td>-0.290411</td>
<td>1.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th"></td>
<td>June 15th, 2023</td>
<td>December 15th, 2023</td>
<td>December 15th, 2023</td>
<td>0.50137</td>
<td>0.210959</td>
<td>0.989008</td>
<td>0.495859</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th"></td>
<td>December 15th, 2023</td>
<td>June 15th, 2024</td>
<td>June 17th, 2024</td>
<td>0.50137</td>
<td>0.717808</td>
<td>0.963091</td>
<td>0.482865</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th"></td>
<td>June 15th, 2024</td>
<td>December 15th, 2024</td>
<td>December 16th, 2024</td>
<td>0.50137</td>
<td>1.216438</td>
<td>0.938256</td>
<td>0.470414</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th"></td>
<td>June 15th, 2024</td>
<td>December 15th, 2024</td>
<td>December 16th, 2024</td>
<td>100.00000</td>
<td>1.216438</td>
<td>0.938256</td>
<td>93.825649</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'bond_yield_quantlib.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-50-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We reuse obtained yield to maturity to check bond attributes with QuantLib pricer</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we build a flat curve using this yield</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>spot_curve <span class="op">=</span> ql.FlatForward(ql.Date(<span class="dv">29</span>, <span class="dv">9</span>, <span class="dv">2023</span>),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                            ql.QuoteHandle(ql.SimpleQuote(bond_yield)),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                            day_count,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>                            compounding,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>                            ql.Annual)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>spot_curve_handle <span class="op">=</span> ql.YieldTermStructureHandle(spot_curve)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>bond_engine <span class="op">=</span> ql.DiscountingBondEngine(spot_curve_handle)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>bond.setPricingEngine(bond_engine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'settle date: </span><span class="sc">{</span>bond<span class="sc">.</span>settlementDate()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'NPV: </span><span class="sc">{</span>bond<span class="sc">.</span>NPV()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Clean Price: </span><span class="sc">{</span>bond<span class="sc">.</span>cleanPrice()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Accrued Amount: </span><span class="sc">{</span>bond<span class="sc">.</span>accruedAmount()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Dirty Price: </span><span class="sc">{</span>bond<span class="sc">.</span>dirtyPrice()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>compounding_frequency <span class="op">=</span> ql.Semiannual</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'''YTM - Semiannual: </span><span class="sc">{</span>bond<span class="sc">.</span>bondYield(day_count,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>                                          compounding,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>                                          compounding_frequency)<span class="sc">}</span><span class="ss">'''</span>)</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>compounding_frequency <span class="op">=</span> ql.Annual</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'''YTM - Annual: </span><span class="sc">{</span>bond<span class="sc">.</span>bondYield(day_count,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>                                          compounding,</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>                                          compounding_frequency)<span class="sc">}</span><span class="ss">'''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>settle date: September 29th, 2023
NPV: 95.2747861295364
Clean Price: 94.98437517063226
Accrued Amount: 0.2904109589041193
Dirty Price: 95.27478612953638
YTM - Semiannual: 0.053084497451782224
YTM - Annual: 0.053788992781693884</code></pre>
</div>
</div>
<p>As an alternative to <code>scipy.optimize.bisect</code> or <code>scipy.optimize.newton</code>, we propose here to implement ourselves three different solvers as suggested in the exercise:</p>
<p>First using the bisection method as described in the Wikipedia article <a href="https://en.wikipedia.org/wiki/Bisection_method">here</a> (see also <a href="https://pythonnumericalmethods.berkeley.edu/notebooks/chapter19.00-Root-Finding.html">here</a>):</p>
<div class="cell" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source https://github.com/better/irr</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'bisect.gif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;IPython.core.display.Image object&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solve_root_bisection(func, a, b, tol <span class="op">=</span> <span class="fl">1e-8</span>, n_iter <span class="op">=</span> <span class="dv">200</span>, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Find an approximate root of f(x)=0 on interval [a,b] using bisection/dichotomy.</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co">    func : function</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="co">        The function for which we are trying to approximate a solution f(x)=0.</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co">    a,b : float</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co">        The interval in which to search for a solution. The function returns</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co">        None if f(a)*f(b) &gt;= 0 since a solution is not guaranteed.</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="co">    tol: float</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="co">        The function stops when it finds m = (a_k + b_k) / 2 such that |f(m)| &lt; tol</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : integer</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Or the number of iterations is reached.</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="co">    verbose : boolean</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="co">        If True print intermediate values at each iteration.</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="co">    m : number</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a><span class="co">        The midpoint of the nth interval computed by the bisection method. The</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="co">        initial interval [a_0,b_0] is [a,b]. If f(m) == 0 for some</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co">        midpoint m = (a_n + b_n)/2, then the function returns this solution.</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="co">        If all signs of values f(a_n), f(b_n) and f(m_n) are the same at any</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="co">        iteration, the bisection method fails and return None.</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: (x - 1)*(x + 3)</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solve_root_bissection(f,0,10)</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a><span class="co">    1.0000000009313226</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: x ** 2 - 2</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2 = solve_root_bissection(f, 1, 2)</span></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a><span class="co">    1.4142135605216026</span></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; import math</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; abs(sqrt_2 - math.sqrt(2)) &lt; 1e-8</span></span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a><span class="co">    TRUE</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check if a and b are lower/upper bounds of a root</span></span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> func(a)<span class="op">*</span>func(b) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"no root within [a, b], change [a, b]"</span>)</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bissect interval</span></span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> (a <span class="op">+</span> b) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"m: </span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>        check <span class="op">=</span> func(m)</span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"f(m): </span><span class="sc">{</span>check<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># stopping condition |f(m)| &lt; tol</span></span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="bu">abs</span>(check) <span class="op">&gt;=</span> tol:</span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a>            n <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(n <span class="op">&gt;</span> n_iter):</span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"no root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>n_iter<span class="sc">}</span><span class="ss"> iterations"</span>)</span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># case where midpoint improves lower bound</span></span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> check <span class="op">*</span> func(a) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb85-61"><a href="#cb85-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> verbose: </span>
<span id="cb85-62"><a href="#cb85-62" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(n, <span class="st">"pos"</span>)</span>
<span id="cb85-63"><a href="#cb85-63" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f'a: </span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> - root - b:</span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb85-64"><a href="#cb85-64" aria-hidden="true" tabindex="-1"></a>                a <span class="op">=</span> m</span>
<span id="cb85-65"><a href="#cb85-65" aria-hidden="true" tabindex="-1"></a>                m <span class="op">=</span> (a <span class="op">+</span> b) <span class="op">/</span> <span class="dv">2</span> </span>
<span id="cb85-66"><a href="#cb85-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># case where midpoint improves upper bound</span></span>
<span id="cb85-67"><a href="#cb85-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb85-68"><a href="#cb85-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> verbose: </span>
<span id="cb85-69"><a href="#cb85-69" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(n, <span class="st">"neg"</span>)</span>
<span id="cb85-70"><a href="#cb85-70" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f'a: </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss"> - root - b:</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb85-71"><a href="#cb85-71" aria-hidden="true" tabindex="-1"></a>                b <span class="op">=</span> m</span>
<span id="cb85-72"><a href="#cb85-72" aria-hidden="true" tabindex="-1"></a>                m <span class="op">=</span> (a <span class="op">+</span> b) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb85-73"><a href="#cb85-73" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb85-74"><a href="#cb85-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"m: </span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-75"><a href="#cb85-75" aria-hidden="true" tabindex="-1"></a>            check <span class="op">=</span> func(m)</span>
<span id="cb85-76"><a href="#cb85-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"f(m): </span><span class="sc">{</span>check<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-77"><a href="#cb85-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-78"><a href="#cb85-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then using the <a href="https://en.wikipedia.org/wiki/Secant_method">Secant method</a> (which we already used using scipy.optimize.newton as we didn’t pass a derivative function to the optimizer):</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solve_root_secant(func, x0, x1, tol <span class="op">=</span> <span class="fl">1e-8</span>, n_iter <span class="op">=</span> <span class="dv">200</span>, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Find an approximate root of f(x)=0 using secant method with starting points x0, x1.</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">    func : function</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">        The function for which we are trying to approximate a solution f(x)=0.</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">    x0,x1 : float</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Two initial values to initiate the recurrence relation, should be 'close enough' to the root</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co">        https://en.wikipedia.org/wiki/Secant_method</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co">        xn = xn-1 - f(xn-1)*(xn-2 - xn-1)/(f(xn-1) - f(xn-2))</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co">    tol: float</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The function stops when it finds xn such that |f(xn)| &lt; tol</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : integer</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Or the number of iterations is reached.</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="co">    verbose : boolean</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="co">        If True print intermediate values at each iteration.</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="co">    xn : float</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a><span class="co">        xn such that |f(xn)| &lt; tol</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a><span class="co">        In case the secant method fails to converge it returns None.</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: (x - 1)*(x + 3)</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solve_root_secant(f,0,1,10)</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a><span class="co">    0.9999999988888671</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: x ** 2 - 2</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2 = solve_root_secant(f, 1, 2)</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="co">    1.4142135620573204</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; import math</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; abs(sqrt_2 - math.sqrt(2)) &lt; 1e-8</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a><span class="co">    TRUE</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">abs</span>(func(x0)) <span class="op">&lt;</span> tol:</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span><span class="dv">0</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x0</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">abs</span>(func(x1)) <span class="op">&lt;</span> tol:</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x1</span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize recurrence relation</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    xn_minus_1 <span class="op">=</span> x1</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>    xn_minus_2 <span class="op">=</span> x0</span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update reccurence until stopping condition |f(xn)| &lt; tol is met</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, n_iter):</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>        xn <span class="op">=</span> xn_minus_1 <span class="op">-</span> func(xn_minus_1) <span class="op">*</span> (xn_minus_1 <span class="op">-</span> xn_minus_2) <span class="op">/</span> (func(xn_minus_1) <span class="op">-</span> func(xn_minus_2))       </span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>        check <span class="op">=</span> func(xn)</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"Step </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: xn-2: </span><span class="sc">{</span>xn_minus_2<span class="sc">}</span><span class="ss">, xn-1: </span><span class="sc">{</span>xn_minus_1<span class="sc">}</span><span class="ss">, xn: </span><span class="sc">{</span>xn<span class="sc">}</span><span class="ss">, f(xn): </span><span class="sc">{</span>check<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(check) <span class="op">&lt;</span> tol:</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> xn</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>        xn_minus_2 <span class="op">=</span> xn_minus_1</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>        xn_minus_1 <span class="op">=</span> xn</span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"no root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>n_iter<span class="sc">}</span><span class="ss"> iterations"</span>)</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And to finish using the <a href="https://en.wikipedia.org/wiki/Newton%27s_method">Newton method</a>:</p>
<div class="cell" data-execution_count="49">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'newton.gif'</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'newton_method.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;IPython.core.display.Image object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-57-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> solve_root_newton(func, deriv, x0, tol <span class="op">=</span> <span class="fl">1e-8</span>, n_iter <span class="op">=</span> <span class="dv">200</span>, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Find an approximate root of f(x)=0 using secant method with starting points x0, x1.</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">    func : function</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co">        The function for which we are trying to approximate a solution f(x)=0.</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co">    deriv : function</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co">        The derivative of the function for which we are trying to approximate a solution f(x)=0.</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">    x0: float</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Initial guess for the root</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="co">    https://en.wikipedia.org/wiki/Newton%27s_method</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co">    xn+1 = xn - f(xn)/f'(xn)</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co">    tol: float</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co">        The function stops when it finds xn such that |f(xn)| &lt; tol</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : integer</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Or the number of iterations is reached.</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co">    verbose : boolean</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co">        If True print intermediate values at each iteration.</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a><span class="co">    xn : float</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a><span class="co">        xn such that |f(xn)| &lt; tol</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co">        In case the newton method fails to converge it returns None.</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Example</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: (x - 1)*(x + 3)</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; df = lambda x: 2 * (x + 1)</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solve_root_newton(f, df, 0)</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a><span class="co">    1.0000000000000022</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; f = lambda x: x ** 2 - 2</span></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; df = lambda x: 2 * x</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2 = solve_root_newton(f, df, 1)</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sqrt_2</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="co">    1.4142135623746899</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; import math</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; abs(sqrt_2 - math.sqrt(2)) &lt; 1e-8</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a><span class="co">    TRUE</span></span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">abs</span>(func(x0)) <span class="op">&lt;</span> tol:</span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span><span class="dv">0</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x0</span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize recurrence relation</span></span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>    xn <span class="op">=</span> x0</span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update reccurence until stopping condition |f(xn)| &lt; tol is met</span></span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_iter):</span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> deriv <span class="op">==</span> <span class="fl">0.0</span>:</span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Newton method fails, derivative is nul at </span><span class="sc">{</span>xn<span class="sc">}</span><span class="ss"> for initial guess </span><span class="sc">{</span>x0<span class="sc">}</span><span class="ss">, try another initial guess"</span>)</span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a>            xn_plus_1 <span class="op">=</span> xn <span class="op">-</span> func(xn) <span class="op">/</span> deriv(xn)       </span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a>            check <span class="op">=</span> func(xn_plus_1)</span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose: <span class="bu">print</span>(<span class="ss">f"Step </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: xn: </span><span class="sc">{</span>xn<span class="sc">}</span><span class="ss">, xn+1: </span><span class="sc">{</span>xn_plus_1<span class="sc">}</span><span class="ss">, f(xn+1): </span><span class="sc">{</span>check<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(check) <span class="op">&lt;</span> tol:</span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> at iteration </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> xn_plus_1</span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a>            xn <span class="op">=</span> xn_plus_1</span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"no root found within tolerance </span><span class="sc">{</span>tol<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>n_iter<span class="sc">}</span><span class="ss"> iterations"</span>)</span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking our functions to compute sqrt(2) as a solution to x ** 2 - 2 = 0 on [1, 2]:</p>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># defining equation to solve</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="kw">lambda</span> x: x <span class="op">**</span> <span class="dv">2</span> <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'------------------ bisection method ------------------'</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>sqrt_2 <span class="op">=</span> solve_root_bisection(f, <span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">1e-8</span>, <span class="dv">200</span>, <span class="va">True</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sqrt_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>------------------ bisection method ------------------
m: 1.5
f(m): 0.25
1 neg
a: 1 - root - b:1.5
m: 1.25
f(m): -0.4375
2 pos
a: 1.25 - root - b:1.5
m: 1.375
f(m): -0.109375
3 pos
a: 1.375 - root - b:1.5
m: 1.4375
f(m): 0.06640625
4 neg
a: 1.375 - root - b:1.4375
m: 1.40625
f(m): -0.0224609375
5 pos
a: 1.40625 - root - b:1.4375
m: 1.421875
f(m): 0.021728515625
6 neg
a: 1.40625 - root - b:1.421875
m: 1.4140625
f(m): -0.00042724609375
7 pos
a: 1.4140625 - root - b:1.421875
m: 1.41796875
f(m): 0.0106353759765625
8 neg
a: 1.4140625 - root - b:1.41796875
m: 1.416015625
f(m): 0.005100250244140625
9 neg
a: 1.4140625 - root - b:1.416015625
m: 1.4150390625
f(m): 0.0023355484008789062
10 neg
a: 1.4140625 - root - b:1.4150390625
m: 1.41455078125
f(m): 0.0009539127349853516
11 neg
a: 1.4140625 - root - b:1.41455078125
m: 1.414306640625
f(m): 0.0002632737159729004
12 neg
a: 1.4140625 - root - b:1.414306640625
m: 1.4141845703125
f(m): -8.200109004974365e-05
13 pos
a: 1.4141845703125 - root - b:1.414306640625
m: 1.41424560546875
f(m): 9.063258767127991e-05
14 neg
a: 1.4141845703125 - root - b:1.41424560546875
m: 1.414215087890625
f(m): 4.314817488193512e-06
15 neg
a: 1.4141845703125 - root - b:1.414215087890625
m: 1.4141998291015625
f(m): -3.8843369111418724e-05
16 pos
a: 1.4141998291015625 - root - b:1.414215087890625
m: 1.4142074584960938
f(m): -1.726433401927352e-05
17 pos
a: 1.4142074584960938 - root - b:1.414215087890625
m: 1.4142112731933594
f(m): -6.474772817455232e-06
18 pos
a: 1.4142112731933594 - root - b:1.414215087890625
m: 1.4142131805419922
f(m): -1.0799813026096672e-06
19 pos
a: 1.4142131805419922 - root - b:1.414215087890625
m: 1.4142141342163086
f(m): 1.6174171832972206e-06
20 neg
a: 1.4142131805419922 - root - b:1.4142141342163086
m: 1.4142136573791504
f(m): 2.687177129701013e-07
21 neg
a: 1.4142131805419922 - root - b:1.4142136573791504
m: 1.4142134189605713
f(m): -4.056318516632018e-07
22 pos
a: 1.4142134189605713 - root - b:1.4142136573791504
m: 1.4142135381698608
f(m): -6.845708355740499e-08
23 pos
a: 1.4142135381698608 - root - b:1.4142136573791504
m: 1.4142135977745056
f(m): 1.0013031115363447e-07
24 neg
a: 1.4142135381698608 - root - b:1.4142135977745056
m: 1.4142135679721832
f(m): 1.583661290993632e-08
25 neg
a: 1.4142135381698608 - root - b:1.4142135679721832
m: 1.414213553071022
f(m): -2.6310235545778937e-08
26 pos
a: 1.414213553071022 - root - b:1.4142135679721832
m: 1.4142135605216026
f(m): -5.236811428943611e-09
root found within tolerance 1e-08 at iteration 26
1.4142135605216026</code></pre>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'------------------ secant method ------------------'</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(solve_root_secant(f, <span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">1e-8</span>, <span class="dv">200</span>, <span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>------------------ secant method ------------------
Step 2: xn-2: 1, xn-1: 2, xn: 1.3333333333333335, f(xn): -0.22222222222222188
Step 3: xn-2: 2, xn-1: 1.3333333333333335, xn: 1.4000000000000001, f(xn): -0.03999999999999959
Step 4: xn-2: 1.3333333333333335, xn-1: 1.4000000000000001, xn: 1.4146341463414633, f(xn): 0.0011897679952408424
Step 5: xn-2: 1.4000000000000001, xn-1: 1.4146341463414633, xn: 1.41421143847487, f(xn): -6.007286838860537e-06
Step 6: xn-2: 1.4146341463414633, xn-1: 1.41421143847487, xn: 1.4142135620573204, f(xn): -8.931455575122982e-10
root found within tolerance 1e-08 at iteration 6
1.4142135620573204</code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'------------------ newton method ------------------'</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># defining derivative</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="kw">lambda</span> x: <span class="dv">2</span> <span class="op">*</span> x </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(solve_root_newton(f, df, <span class="dv">1</span>, <span class="fl">1e-8</span>, <span class="dv">200</span>, <span class="va">True</span>))</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(sqrt_2 <span class="op">-</span> math.sqrt(<span class="dv">2</span>)) <span class="op">&lt;</span> <span class="fl">1e-8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>------------------ newton method ------------------
Step 1: xn: 1, xn+1: 1.5, f(xn+1): 0.25
Step 2: xn: 1.5, xn+1: 1.4166666666666667, f(xn+1): 0.006944444444444642
Step 3: xn: 1.4166666666666667, xn+1: 1.4142156862745099, f(xn+1): 6.007304882871267e-06
Step 4: xn: 1.4142156862745099, xn+1: 1.4142135623746899, f(xn+1): 4.510614104447086e-12
root found within tolerance 1e-08 at iteration 4
1.4142135623746899</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>True</code></pre>
</div>
</div>
<ul>
<li>Apply the <code>yield_from_price</code> to your pandas DataFrame of US treasury prices, to get a bid/ask yield to maturity for each day/CUSIP where SECURITY TYPE is either <code>MARKET BASED NOTE</code> or <code>MARKET BASED BOND</code>.</li>
</ul>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> df_treasuries_prices[<span class="st">'SECURITY TYPE'</span>].isin([<span class="st">'MARKET BASED NOTE'</span>, <span class="st">'MARKET BASED BOND'</span>])</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds <span class="op">=</span> (df_treasuries_prices[mask].</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>rename(</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VALUE DATE'</span>: <span class="st">'VALUE_DATE'</span>, </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MATURITY DATE'</span>: <span class="st">'MATURITY_DATE'</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds[<span class="st">'RATE'</span>] <span class="op">*=</span> <span class="dv">100</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds.head(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VALUE_DATE</th>
<th data-quarto-table-cell-role="th">CUSIP</th>
<th data-quarto-table-cell-role="th">SECURITY TYPE</th>
<th data-quarto-table-cell-role="th">RATE</th>
<th data-quarto-table-cell-role="th">MATURITY_DATE</th>
<th data-quarto-table-cell-role="th">CALL DATE</th>
<th data-quarto-table-cell-role="th">BUY</th>
<th data-quarto-table-cell-role="th">SELL</th>
<th data-quarto-table-cell-role="th">END OF DAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>2023-09-14</td>
<td>91282CAK7</td>
<td>MARKET BASED NOTE</td>
<td>0.125</td>
<td>2023-09-15</td>
<td>NaN</td>
<td>0.0</td>
<td>99.96875</td>
<td>100.00000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>2023-09-14</td>
<td>9128285D8</td>
<td>MARKET BASED NOTE</td>
<td>2.875</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.0</td>
<td>99.87500</td>
<td>99.87500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>2023-09-14</td>
<td>912828T26</td>
<td>MARKET BASED NOTE</td>
<td>1.375</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.0</td>
<td>99.81250</td>
<td>99.78125</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>2023-09-14</td>
<td>91282CDA6</td>
<td>MARKET BASED NOTE</td>
<td>0.250</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.0</td>
<td>99.75000</td>
<td>99.75000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> df_treasuries_bonds.head(<span class="dv">3</span>).itertuples():</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pandas(Index=50, VALUE_DATE=Timestamp('2023-09-14 00:00:00'), CUSIP='91282CAK7', _3='MARKET BASED NOTE', RATE=0.125, MATURITY_DATE=Timestamp('2023-09-15 00:00:00'), _6=nan, BUY=0.0, SELL=99.96875, _9=100.0)
Pandas(Index=51, VALUE_DATE=Timestamp('2023-09-14 00:00:00'), CUSIP='9128285D8', _3='MARKET BASED NOTE', RATE=2.875, MATURITY_DATE=Timestamp('2023-09-30 00:00:00'), _6=nan, BUY=0.0, SELL=99.875, _9=99.875)
Pandas(Index=52, VALUE_DATE=Timestamp('2023-09-14 00:00:00'), CUSIP='912828T26', _3='MARKET BASED NOTE', RATE=1.375, MATURITY_DATE=Timestamp('2023-09-30 00:00:00'), _6=nan, BUY=0.0, SELL=99.8125, _9=99.78125)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>bond_ytm_excel(clean_price,</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(pricing_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),  </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>               datetime.datetime.strptime(maturity_date, <span class="st">'</span><span class="sc">%d</span><span class="st">/%m/%Y'</span>),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>               coupon,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>               <span class="dv">100</span>,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>               freq,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>               <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>0.053326008642049956</code></pre>
</div>
</div>
<p>Applying a complex function (not straightforward to ‘vectorize’)</p>
<p>Using pandas itertuples (ie iterating on rows, then working with tuples)</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> itertuples_bond_yld(df):</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> pd.Series(</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    bond_ytm_excel(</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>      row.SELL, row.VALUE_DATE, row.MATURITY_DATE, row.RATE, <span class="fl">100.0</span>, <span class="dv">2</span>, <span class="fl">0.03</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> df.itertuples()</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit itertuples_bond_yld(df_treasuries_bonds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.03 s ± 18.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>VALUE_DATE       datetime64[ns]
CUSIP                    object
SECURITY TYPE            object
RATE                    float64
MATURITY_DATE    datetime64[ns]
CALL DATE               float64
BUY                     float64
SELL                    float64
END OF DAY              float64
dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds.loc[<span class="dv">4000</span>:,<span class="st">'SELL_YTM'</span>] <span class="op">=</span> itertuples_bond_yld(df_treasuries_bonds.loc[<span class="dv">4000</span>:,:])</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VALUE_DATE</th>
<th data-quarto-table-cell-role="th">CUSIP</th>
<th data-quarto-table-cell-role="th">SECURITY TYPE</th>
<th data-quarto-table-cell-role="th">RATE</th>
<th data-quarto-table-cell-role="th">MATURITY_DATE</th>
<th data-quarto-table-cell-role="th">CALL DATE</th>
<th data-quarto-table-cell-role="th">BUY</th>
<th data-quarto-table-cell-role="th">SELL</th>
<th data-quarto-table-cell-role="th">END OF DAY</th>
<th data-quarto-table-cell-role="th">SELL_YTM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>2023-09-14</td>
<td>91282CAK7</td>
<td>MARKET BASED NOTE</td>
<td>0.125</td>
<td>2023-09-15</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.96875</td>
<td>100.00000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>2023-09-14</td>
<td>9128285D8</td>
<td>MARKET BASED NOTE</td>
<td>2.875</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.87500</td>
<td>99.87500</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>2023-09-14</td>
<td>912828T26</td>
<td>MARKET BASED NOTE</td>
<td>1.375</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.81250</td>
<td>99.78125</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>2023-09-14</td>
<td>91282CDA6</td>
<td>MARKET BASED NOTE</td>
<td>0.250</td>
<td>2023-09-30</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.75000</td>
<td>99.75000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>2023-09-14</td>
<td>91282CAP6</td>
<td>MARKET BASED NOTE</td>
<td>0.125</td>
<td>2023-10-15</td>
<td>NaN</td>
<td>0.000000</td>
<td>99.53125</td>
<td>99.53125</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5245</td>
<td>2023-09-29</td>
<td>912810TJ7</td>
<td>MARKET BASED BOND</td>
<td>3.000</td>
<td>2052-08-15</td>
<td>NaN</td>
<td>73.109375</td>
<td>73.06250</td>
<td>72.53125</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5246</td>
<td>2023-09-29</td>
<td>912810TL2</td>
<td>MARKET BASED BOND</td>
<td>4.000</td>
<td>2052-11-15</td>
<td>NaN</td>
<td>88.921875</td>
<td>88.87500</td>
<td>88.28125</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5247</td>
<td>2023-09-29</td>
<td>912810TN8</td>
<td>MARKET BASED BOND</td>
<td>3.625</td>
<td>2053-02-15</td>
<td>NaN</td>
<td>82.968750</td>
<td>82.93750</td>
<td>82.37500</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5248</td>
<td>2023-09-29</td>
<td>912810TR9</td>
<td>MARKET BASED BOND</td>
<td>3.625</td>
<td>2053-05-15</td>
<td>NaN</td>
<td>83.062500</td>
<td>83.03125</td>
<td>82.43750</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5249</td>
<td>2023-09-29</td>
<td>912810TT5</td>
<td>MARKET BASED BOND</td>
<td>4.125</td>
<td>2053-08-15</td>
<td>NaN</td>
<td>91.046875</td>
<td>91.03125</td>
<td>90.40625</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>4008 rows × 10 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>val <span class="op">=</span> df_treasuries_bonds.at[<span class="dv">5248</span>,<span class="st">'VALUE_DATE'</span>]</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>mat <span class="op">=</span> df_treasuries_bonds.at[<span class="dv">5248</span>,<span class="st">'MATURITY_DATE'</span>]</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>rate <span class="op">=</span> df_treasuries_bonds.at[<span class="dv">5248</span>,<span class="st">'RATE'</span>]</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>sell <span class="op">=</span> df_treasuries_bonds.at[<span class="dv">5248</span>,<span class="st">'SELL'</span>]</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>bond_ytm_excel(sell, val, mat, rate, <span class="dv">100</span>, <span class="dv">2</span>, <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>0.04690496896140147</code></pre>
</div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds[<span class="st">'BUY_YTM'</span>]<span class="op">=</span> df_treasuries_bonds.<span class="bu">apply</span>(<span class="kw">lambda</span> x: bond_ytm_excel(x[<span class="st">'BUY'</span>], x[<span class="st">'VALUE_DATE'</span>], x[<span class="st">'MATURITY_DATE'</span>], x[<span class="st">'RATE'</span>], <span class="dv">100</span>, <span class="dv">2</span>, <span class="fl">0.06</span>) <span class="cf">if</span> x[<span class="st">'BUY'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds[<span class="st">'SELL_YTM'</span>] <span class="op">=</span> df_treasuries_bonds.<span class="bu">apply</span>(<span class="kw">lambda</span> x: bond_ytm_excel(x[<span class="st">'SELL'</span>], x[<span class="st">'VALUE_DATE'</span>], x[<span class="st">'MATURITY_DATE'</span>], x[<span class="st">'RATE'</span>], <span class="dv">100</span>, <span class="dv">2</span>, <span class="fl">0.06</span>) <span class="cf">if</span> x[<span class="st">'SELL'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">=</span> (df_treasuries_bonds[<span class="st">'MATURITY_DATE'</span>] <span class="op">-</span> df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>]).dt.days <span class="op">/</span> <span class="dv">365</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>(df_treasuries_bonds.</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-29'</span>) <span class="op">&amp;</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;</span> <span class="fl">0.04</span>)].</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    plot(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span>[<span class="st">'BUY_YTM'</span>, <span class="st">'SELL_YTM'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>&lt;Axes: xlabel='MATURITY_YEARS'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-71-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>(df_treasuries_bonds.</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-29'</span>) <span class="op">&amp;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;</span> <span class="fl">0.04</span>) <span class="op">&amp;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;</span> <span class="dv">10</span>)].</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    plot(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span>[<span class="st">'BUY_YTM'</span>, <span class="st">'SELL_YTM'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>&lt;Axes: xlabel='MATURITY_YEARS'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-72-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> (df_treasuries_bonds.</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">15</span>) <span class="op">&amp;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>)].</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'BUY_YTM'</span>, color<span class="op">=</span> <span class="st">'blue'</span>, label <span class="op">=</span> <span class="st">'Buy'</span>))</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>(df_treasuries_bonds.</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">15</span>) <span class="op">&amp;</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>)].</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'SELL_YTM'</span>, color<span class="op">=</span> <span class="st">'orange'</span>, label <span class="op">=</span> <span class="st">'Sell'</span>, ax <span class="op">=</span>ax))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>&lt;Axes: xlabel='MATURITY_YEARS', ylabel='SELL_YTM'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-73-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> (df_treasuries_bonds.</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>)].</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'BUY_YTM'</span>, color<span class="op">=</span> <span class="st">'blue'</span>, label <span class="op">=</span> <span class="st">'Buy'</span>))</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>(df_treasuries_bonds.</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>)].</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'SELL_YTM'</span>, color<span class="op">=</span> <span class="st">'orange'</span>, label <span class="op">=</span> <span class="st">'Sell'</span>, ax <span class="op">=</span>ax))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>&lt;Axes: xlabel='MATURITY_YEARS', ylabel='SELL_YTM'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-74-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> (df_treasuries_bonds.</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">12</span>)].</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'BUY_YTM'</span>, color<span class="op">=</span> <span class="st">'blue'</span>, label <span class="op">=</span> <span class="st">'Buy'</span>))</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>(df_treasuries_bonds.</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">12</span>)].</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    sort_values(<span class="st">'MATURITY_YEARS'</span>).</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    plot.scatter(x<span class="op">=</span><span class="st">'MATURITY_YEARS'</span>, y<span class="op">=</span><span class="st">'SELL_YTM'</span>, color<span class="op">=</span> <span class="st">'orange'</span>, label <span class="op">=</span> <span class="st">'Sell'</span>, ax <span class="op">=</span>ax))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>&lt;Axes: xlabel='MATURITY_YEARS', ylabel='SELL_YTM'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-75-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Nelson Siegel</p>
<div class="cell" data-execution_count="129">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>img_colab(<span class="st">'nelson_siegel.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-76-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import numpy as np</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>maturity_array <span class="op">=</span> (df_treasuries_bonds.</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-14'</span>) <span class="op">&amp;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="fl">0.5</span>) <span class="op">&amp;</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>), <span class="st">'MATURITY_YEARS'</span>].</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    to_numpy())</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>maturity_array[:<span class="dv">15</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>array([0.50136986, 0.54520548, 0.54520548, 0.58630137, 0.62739726,
       0.62739726, 0.62739726, 0.66849315, 0.66849315, 0.71232877,
       0.71232877, 0.75342466, 0.79452055, 0.79452055, 0.79452055])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>yield_array <span class="op">=</span> (df_treasuries_bonds.</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    loc[(df_treasuries_bonds[<span class="st">'VALUE_DATE'</span>] <span class="op">==</span> <span class="st">'2023-09-22'</span>) <span class="op">&amp;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&gt;=</span> <span class="fl">0.5</span>) <span class="op">&amp;</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>        (df_treasuries_bonds[<span class="st">'MATURITY_YEARS'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>), <span class="st">'BUY_YTM'</span>].</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    to_numpy())</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>yield_array[:<span class="dv">15</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>array([0.05416954, 0.05387549, 0.05371413, 0.05434537, 0.05444344,
       0.05454124, 0.05434234, 0.05405707, 0.05444357, 0.05450546,
       0.05428964, 0.05457883, 0.05460306, 0.05469552, 0.05433525])</code></pre>
</div>
</div>
<p>https://stackoverflow.com/questions/71846376/calibrate-parameters-of-yield-curve-nelson-siegel-svensson</p>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>beta0   <span class="op">=</span> <span class="fl">0.001</span> <span class="co"># initial guess</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>beta1   <span class="op">=</span> <span class="fl">0.001</span> <span class="co"># initial guess</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>beta2   <span class="op">=</span> <span class="fl">0.001</span> <span class="co"># initial guess</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>beta3   <span class="op">=</span> <span class="fl">0.001</span> <span class="co"># initial guess</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>tau1 <span class="op">=</span> <span class="dv">1</span> <span class="co"># initial guess</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>tau2 <span class="op">=</span> <span class="dv">1</span> <span class="co"># initial guess</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>param_array_nss <span class="op">=</span> np.array([beta0, beta1, beta2, beta3, tau1, tau2])</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>param_array_ns <span class="op">=</span> np.array([beta0, beta1, beta2, tau1])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Nelson Siegel Svensson</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nss_yield(m, param_array):</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    beta0 <span class="op">=</span> param_array[<span class="dv">0</span>]</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    beta1 <span class="op">=</span> param_array[<span class="dv">1</span>]</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    beta2 <span class="op">=</span> param_array[<span class="dv">2</span>]</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    beta3 <span class="op">=</span> param_array[<span class="dv">3</span>]</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    tau1 <span class="op">=</span> param_array[<span class="dv">4</span>]</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>    tau2 <span class="op">=</span> param_array[<span class="dv">5</span>]</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    short_term_component <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau1)) <span class="op">/</span> (m <span class="op">/</span> tau1)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    medium_term_component <span class="op">=</span> short_term_component <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau1)</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    second_hump_component <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau2)) <span class="op">/</span> (m <span class="op">/</span> tau2) <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau2)</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>    nss_yield <span class="op">=</span> np.where(m<span class="op">==</span><span class="dv">0</span>, beta0 <span class="op">+</span> beta1, beta0 <span class="op">+</span> beta1 <span class="op">*</span> short_term_component <span class="op">+</span> beta2 <span class="op">*</span> medium_term_component <span class="op">+</span> beta3 <span class="op">*</span> second_hump_component)</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(nss_yield)</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nss_mse(param_array, maturity_array, yield_array):</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>((nss_yield(maturity_array, param_array)<span class="op">-</span>yield_array)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nss_fit(param_array, maturity_array, yield_array):</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    fitted_params <span class="op">=</span> optimize.minimize(nss_mse, x0<span class="op">=</span>param_array, args <span class="op">=</span> (maturity_array, yield_array), method<span class="op">=</span><span class="st">"Nelder-Mead"</span>)</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fitted_params.success):</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fitted_params.x</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Unable to fit NSS'</span>)</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Nelson Siegel</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ns_yield(m, param_array):</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    beta0 <span class="op">=</span> param_array[<span class="dv">0</span>]</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    beta1 <span class="op">=</span> param_array[<span class="dv">1</span>]</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    beta2 <span class="op">=</span> param_array[<span class="dv">2</span>]</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    tau1 <span class="op">=</span> param_array[<span class="dv">3</span>]</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    short_term_component <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau1)) <span class="op">/</span> (m <span class="op">/</span> tau1)</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    medium_term_component <span class="op">=</span> short_term_component <span class="op">-</span> np.exp(<span class="op">-</span>m <span class="op">/</span> tau1)</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    nss_yield <span class="op">=</span> np.where(m<span class="op">==</span><span class="dv">0</span>, beta0 <span class="op">+</span> beta1, beta0 <span class="op">+</span> beta1 <span class="op">*</span> short_term_component <span class="op">+</span> beta2 <span class="op">*</span> medium_term_component)</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(nss_yield)</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ns_mse(param_array, maturity_array, yield_array):</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>((ns_yield(maturity_array, param_array)<span class="op">-</span>yield_array)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ns_fit(param_array, maturity_array, yield_array):</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>    fitted_params <span class="op">=</span> optimize.minimize(ns_mse, x0<span class="op">=</span>param_array, args <span class="op">=</span> (maturity_array, yield_array), method<span class="op">=</span><span class="st">"Nelder-Mead"</span>)</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fitted_params.success):</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fitted_params.x</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Unable to fit NS'</span>)</span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import scipy</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>fitted_params_nss <span class="op">=</span> nss_fit(param_array_nss, maturity_array, yield_array) </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fitted_params_nss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[ 4.99507658e-02  8.06632364e-03 -5.39977602e-02  2.61836626e-02
  5.00601842e+00  9.24116518e+00]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/qb/99v_gzds7j7725jspcz_ch9w0000gn/T/ipykernel_21005/1401950849.py:19: RuntimeWarning: overflow encountered in square
  return np.sum((nss_yield(maturity_array, param_array)-yield_array)**2)
/var/folders/qb/99v_gzds7j7725jspcz_ch9w0000gn/T/ipykernel_21005/1401950849.py:13: RuntimeWarning: overflow encountered in exp
  second_hump_component = (1 - np.exp(-m / tau2)) / (m / tau2) - np.exp(-m / tau2)
/var/folders/qb/99v_gzds7j7725jspcz_ch9w0000gn/T/ipykernel_21005/1401950849.py:13: RuntimeWarning: invalid value encountered in subtract
  second_hump_component = (1 - np.exp(-m / tau2)) / (m / tau2) - np.exp(-m / tau2)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>interp_maturity_array_nss <span class="op">=</span> np.linspace(start<span class="op">=</span><span class="fl">0.01</span>, stop<span class="op">=</span>np.ceil(maturity_array[<span class="op">-</span><span class="dv">1</span>]), num<span class="op">=</span>(maturity_array.size<span class="op">*</span><span class="dv">20</span>))</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>interp_yield_array_nss <span class="op">=</span> nss_yield(interp_maturity_array_nss, fitted_params_nss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Implementation</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>fitted_params_ns <span class="op">=</span> ns_fit(param_array_ns, maturity_array, yield_array) </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the yield curve with optimal parameter to compare with the data provided</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fitted_params_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[ 5.52867800e-02  2.79774328e-03 -4.06359080e-02  4.45773038e+00]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>interp_maturity_array_ns <span class="op">=</span> np.linspace(start<span class="op">=</span><span class="fl">0.01</span>, stop<span class="op">=</span>np.ceil(maturity_array[<span class="op">-</span><span class="dv">1</span>]), num<span class="op">=</span>(maturity_array.size<span class="op">*</span><span class="dv">20</span>))</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>interp_yield_array_ns <span class="op">=</span> ns_yield(interp_maturity_array_ns, fitted_params_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>ax.plot(interp_maturity_array_nss , interp_yield_array_nss, label<span class="op">=</span><span class="st">"Nelson Siegel Svensson Yields"</span>)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>ax.plot(interp_maturity_array_ns , interp_yield_array_ns, label<span class="op">=</span><span class="st">"Nelson Siegel Yields"</span>)</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>ax.plot(maturity_array , yield_array, <span class="st">'o'</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">"Observed Yields"</span>)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Maturities (in Year)'</span>, ylabel<span class="op">=</span><span class="st">'Bond Yields'</span>,</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>       title<span class="op">=</span><span class="st">'Treasury Buy yields'</span>)</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>ax.grid()</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-86-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nelson_siegel_svensson.calibrate <span class="im">import</span> calibrate_ns_ols, calibrate_nss_ols</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>curve_ns, status_ns <span class="op">=</span> calibrate_ns_ols(maturity_array, yield_array, tau0<span class="op">=</span><span class="fl">1.0</span>)  <span class="co"># starting value of 1.0 for the optimization of tau</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> status_ns.success</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(curve_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NelsonSiegelCurve(beta0=0.052464537855889226, beta1=0.006058847271487039, beta2=-0.03492079295158413, tau=3.808468402690778)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>curve_nss, status_nss <span class="op">=</span> calibrate_nss_ols(maturity_array, yield_array, tau0<span class="op">=</span>(<span class="fl">1.0</span>, <span class="fl">2.0</span>))  <span class="co"># starting value of 1.0 for the optimization of tau</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(curve_nss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NelsonSiegelSvenssonCurve(beta0=0.053995474285964504, beta1=-0.028433873378954807, beta2=0.04636494862874748, beta3=-0.033372798309201326, tau1=0.26238248544890447, tau2=4.478443752814598)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">150</span>)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>ax.plot(t, curve_ns(t), label<span class="op">=</span><span class="st">"Nelson Siegel Svensson Yields"</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>ax.plot(t, curve_ns(t), label<span class="op">=</span><span class="st">"Nelson Siegel Yields"</span>)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>ax.plot(maturity_array , yield_array, <span class="st">'o'</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">"Observed Yields"</span>)</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Maturities (in Year)'</span>, ylabel<span class="op">=</span><span class="st">'Bond Yields'</span>,</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>       title<span class="op">=</span><span class="st">'Treasury Buy yields'</span>)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>ax.grid()</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="04_US_treasury_bonds_files/figure-html/cell-89-output-1.png" class="img-fluid"></p>
</div>
</div>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>